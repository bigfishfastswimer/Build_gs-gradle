pipeline {
  agent none

  stages {
    agent any
    stage('prep') {
      script{
        checkout scm
      }
    }
    stage('check') {
      agent any
      steps {
        sh 'if [ ! -d ${HOME}/.gradle ];then \
         mkdir -p ${HOME}/.gradle && chown 1000:1000 ${HOME}/.gradle \
         fi'
      }
    }
    stage('test') {
      agent {
        docker {
          image 'gradle:jdk8'
          args  '-v ${env.HOME}/.gradle:/home/gradle/.gradle'
        }
        steps {
          sh 'cd complete && ./gradlew test'
        }

      }
    }
    stage('Build') {
      agent {
        docker {
          image 'gradle:jdk8'
          args  '-v ${env.HOME}/.gradle:/home/gradle/.gradle'
        }
      steps {
        sh 'cd complete && ./gradlew test'
      }
    }
  }
  post {
    success {
      emailext(
        subject: "${env.JOB_NAME} [${env.BUILD_NUMBER}] has completed successfully",
        body: """<p>'${env.JOB_NAME} [${env.BUILD_NUMBER}]' completed":</p>
        <p>Check console output at <a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a></p>
        ${JELLY_SCRIPT,template="html"}'""",
        to: "fisherhuang1986@gmail.com"
      )
    }
  }
 }
}
